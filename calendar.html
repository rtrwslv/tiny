<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Диапазон дат</title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background-color: #f5f5f5;
  padding: 40px;
}
.calendar-container {
  position: relative;
  display: inline-block;
}
.calendar-button {
  padding: 8px 12px;
  background-color: #fff;
  border: 1px solid #c4c4c4;
  border-radius: 4px;
  cursor: pointer;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.calendar-popup {
  position: absolute;
  top: 45px;
  left: 0;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  padding: 10px;
  width: 360px;
  display: none;
  z-index: 10;
  display: flex;
}
.calendar-popup.active { display: flex; }

.calendar-left {
  width: 100px;
  border-right: 1px solid #ddd;
  overflow-y: auto;
  max-height: 280px;
  padding-right: 6px;
}
.month-option {
  padding: 6px 8px;
  border-radius: 4px;
  cursor: pointer;
  margin-bottom: 2px;
}
.month-option:hover, .month-option.active {
  background-color: #e6e6ff;
}

.calendar-right {
  flex: 1;
  padding-left: 10px;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  margin-bottom: 8px;
}

.year-select {
  position: relative;
}
.year-dropdown {
  position: absolute;
  top: 22px;
  right: 0;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  padding: 4px;
  display: none;
  width: 80px;
  z-index: 20;
  max-height: 150px;
  overflow-y: auto;
}
.year-dropdown.active { display: block; }

.year-option {
  padding: 4px 6px;
  border-radius: 4px;
  cursor: pointer;
}
.year-option:hover { background-color: #f0f0f0; }

.calendar-header button {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 18px;
  color: #555;
}
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  text-align: center;
  gap: 2px;
}
.calendar-day-name {
  font-size: 12px;
  color: #777;
  padding: 4px 0;
}
.calendar-day {
  padding: 6px 0;
  border-radius: 50%;
  cursor: pointer;
  transition: background-color 0.2s, border 0.2s;
}
.calendar-day:hover { background-color: #e4e4ff; }
.calendar-day.selected {
  border: 2px solid #000;
  color: #000;
}
.calendar-day.in-range {
  background-color: #dce0ff;
  color: #000;
}
.calendar-day.inactive { color: #bbb; }
</style>
</head>
<body>

<div class="calendar-container">
  <button class="calendar-button">Выбрать дату</button>
</div>

<script>
const container = document.querySelector('.calendar-container');
const calendarBtn = container.querySelector('.calendar-button');

const calendarPopup = document.createElement('div');
calendarPopup.className = 'calendar-popup';
calendarPopup.id = 'calendar';

const leftPanel = document.createElement('div');
leftPanel.className = 'calendar-left';

const rightPanel = document.createElement('div');
rightPanel.className = 'calendar-right';

const header = document.createElement('div');
header.className = 'calendar-header';

const monthYear = document.createElement('span');
monthYear.id = 'monthYear';

const yearSelect = document.createElement('div');
yearSelect.className = 'year-select';
const yearSpan = document.createElement('span');
yearSpan.textContent = '▼';
const yearDropdown = document.createElement('div');
yearDropdown.className = 'year-dropdown';
yearSelect.append(yearSpan, yearDropdown);

const navContainer = document.createElement('div');
const prevBtn = document.createElement('button');
prevBtn.textContent = '‹';
const nextBtn = document.createElement('button');
nextBtn.textContent = '›';
navContainer.append(prevBtn, nextBtn);

header.append(monthYear, yearSelect, navContainer);

const daysContainer = document.createElement('div');
daysContainer.className = 'calendar-grid';
daysContainer.id = 'calendarDays';

rightPanel.append(header, daysContainer);
calendarPopup.append(leftPanel, rightPanel);
container.appendChild(calendarPopup);

const monthNames = [
  "Январь","Февраль","Март","Апрель","Май","Июнь",
  "Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"
];

let selectedStart = null;
let selectedEnd = null;
let currentDate = new Date();

function renderMonthList() {
  leftPanel.innerHTML = "";
  monthNames.forEach((name, i) => {
    const div = document.createElement("div");
    div.className = "month-option" + (i === currentDate.getMonth() ? " active" : "");
    div.textContent = name;
    div.addEventListener("click", () => {
      currentDate.setMonth(i);
      renderCalendar();
    });
    leftPanel.appendChild(div);
  });
}

function renderYearDropdown() {
  yearDropdown.innerHTML = "";
  const currentYear = currentDate.getFullYear();
  for (let y = currentYear - 5; y <= currentYear + 5; y++) {
    const opt = document.createElement("div");
    opt.className = "year-option";
    opt.textContent = y;
    opt.addEventListener("click", e => {
      e.stopPropagation();
      currentDate.setFullYear(y);
      yearDropdown.classList.remove("active");
      renderCalendar();
    });
    yearDropdown.appendChild(opt);
  }
}

function createDayCell(day, monthOffset = 0) {
  const div = document.createElement("div");
  div.className = "calendar-day" + (monthOffset !== 0 ? " inactive" : "");
  div.textContent = day;

  const dateObj = new Date(currentDate.getFullYear(), currentDate.getMonth() + monthOffset, day);

  if (selectedStart && selectedEnd && dateObj >= selectedStart && dateObj <= selectedEnd)
    div.classList.add("in-range");
  if (
    (selectedStart && dateObj.toDateString() === selectedStart.toDateString()) ||
    (selectedEnd && dateObj.toDateString() === selectedEnd.toDateString())
  ) {
    div.classList.add("selected");
  }

  div.addEventListener("click", () => {
    if (!selectedStart || (selectedStart && selectedEnd)) {
      selectedStart = dateObj;
      selectedEnd = null;
    } else if (dateObj < selectedStart) {
      selectedEnd = selectedStart;
      selectedStart = dateObj;
    } else {
      selectedEnd = dateObj;
    }
    renderCalendar();

    if (selectedStart && !selectedEnd) {
      console.log("Выбрана дата:", selectedStart);
    } else if (selectedStart && selectedEnd) {
      console.log("Выбран диапазон:", selectedStart, "-", selectedEnd);
      calendarPopup.classList.remove("active");
    }
  });

  return div;
}

function renderCalendar() {
  daysContainer.innerHTML = "";
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const firstWeekday = (firstDay.getDay() + 6) % 7; 
  const daysInMonth = lastDay.getDate();

  monthYear.textContent = `${monthNames[month]} ${year}`;
  renderMonthList();
  renderYearDropdown();

  ["Пн","Вт","Ср","Чт","Пт","Сб","Вс"].forEach(name => {
    const div = document.createElement("div");
    div.className = "calendar-day-name";
    div.textContent = name;
    daysContainer.appendChild(div);
  });

  const prevMonthDays = new Date(year, month, 0).getDate();
  const totalCells = firstWeekday + daysInMonth;
  const nextMonthFill = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);

  for(let i=firstWeekday-1; i>=0; i--) daysContainer.appendChild(createDayCell(prevMonthDays-i, -1));
  for(let d=1; d<=daysInMonth; d++) daysContainer.appendChild(createDayCell(d));
  for(let i=1; i<=nextMonthFill; i++) daysContainer.appendChild(createDayCell(i, 1));
}

[prevBtn, nextBtn].forEach((btn, idx) => {
  btn.addEventListener("click", e => {
    e.stopPropagation();
    currentDate.setMonth(currentDate.getMonth() + (idx === 0 ? -1 : 1));
    renderCalendar();
  });
});

calendarBtn.addEventListener("click", e => {
  e.stopPropagation();
  calendarPopup.classList.toggle("active");
  renderCalendar();
});

yearSelect.addEventListener("click", e => {
  e.stopPropagation();
  yearDropdown.classList.toggle("active");
});

document.addEventListener("click", () => {
  calendarPopup.classList.remove("active");
  yearDropdown.classList.remove("active");
});

renderCalendar();
</script>
</body>
</html>


appendTerms(aTerms, aTermCreator, aFilterValue) {
  let startDate, endDate;

  if (aFilterValue.startDate && aFilterValue.endDate) {
    startDate = new Date(aFilterValue.startDate);
    endDate = new Date(aFilterValue.endDate);
    endDate.setDate(endDate.getDate() + 1); // включаем целый последний день
  } else if (aFilterValue.date) {
    startDate = new Date(aFilterValue.date);
    endDate = new Date(startDate);
    endDate.setDate(endDate.getDate() + 1);
  } else {
    console.warn("Invalid date filter:", aFilterValue);
    return;
  }

  const startPRTime = startDate.getTime() * 1000;
  const endPRTime = endDate.getTime() * 1000;

  const termStart = aTermCreator.createTerm();
  termStart.attrib = Ci.nsMsgSearchAttrib.Date;
  termStart.op = Ci.nsMsgSearchOp.IsAfterOrEqual;
  termStart.value = { date: startPRTime, attrib: termStart.attrib };
  termStart.booleanAnd = true;
  termStart.beginsGrouping = true;
  aTerms.push(termStart);

  const termEnd = aTermCreator.createTerm();
  termEnd.attrib = Ci.nsMsgSearchAttrib.Date;
  termEnd.op = Ci.nsMsgSearchOp.IsBefore;
  termEnd.value = { date: endPRTime, attrib: termEnd.attrib };
  termEnd.booleanAnd = true;
  termEnd.endsGrouping = true;
  aTerms.push(termEnd);
}
