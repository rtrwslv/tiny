<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Выпадающий календарь</title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background-color: #f5f5f5;
  padding: 40px;
}
.calendar-container {
  position: relative;
  display: inline-block;
}
.calendar-button {
  padding: 8px 12px;
  background-color: #fff;
  border: 1px solid #c4c4c4;
  border-radius: 4px;
  cursor: pointer;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.calendar-popup {
  position: absolute;
  top: 45px;
  left: 0;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  padding: 10px;
  width: 280px;
  display: none;
  z-index: 10;
}
.calendar-popup.active { display: block; }
.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  margin-bottom: 8px;
}
.month-select {
  display: flex;
  align-items: center;
  gap: 5px;
  cursor: pointer;
  position: relative;
}
.month-dropdown {
  position: absolute;
  top: 22px;
  left: 0;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  padding: 4px;
  display: none;
  width: 120px;
  z-index: 20;
}
.month-dropdown.active { display: block; }
.month-option {
  padding: 4px 6px;
  border-radius: 4px;
  cursor: pointer;
}
.month-option:hover { background-color: #f0f0f0; }
.calendar-header button {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 18px;
  color: #555;
}
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  text-align: center;
  gap: 2px;
}
.calendar-day-name {
  font-size: 12px;
  color: #777;
  padding: 4px 0;
}
.calendar-day {
  padding: 6px 0;
  border-radius: 50%;
  cursor: pointer;
  transition: background-color 0.2s, border 0.2s;
}
.calendar-day:hover { background-color: #e4e4ff; }
.calendar-day.selected {
  border: 2px solid #000;
  color: #000;
}
.calendar-day.inactive { color: #bbb; }
</style>
</head>
<body>

<div class="calendar-container">
  <button class="calendar-button">Открыть календарь</button>
</div>

<script>
const container = document.querySelector('.calendar-container');
const calendarBtn = container.querySelector('.calendar-button');

const calendarPopup = document.createElement('div');
calendarPopup.className = 'calendar-popup';
calendarPopup.id = 'calendar';

const header = document.createElement('div');
header.className = 'calendar-header';

const monthSelect = document.createElement('div');
monthSelect.className = 'month-select';
monthSelect.id = 'monthSelect';

const monthYear = document.createElement('span');
monthYear.className = 'month-year';
monthYear.id = 'monthYear';

const chevron = document.createElement('span');
chevron.className = 'chevron';
chevron.textContent = '▼';

const monthDropdown = document.createElement('div');
monthDropdown.className = 'month-dropdown';
monthDropdown.id = 'monthDropdown';

monthSelect.append(monthYear, chevron, monthDropdown);

const navContainer = document.createElement('div');
const prevBtn = document.createElement('button');
prevBtn.id = 'prevMonth';
prevBtn.textContent = '‹';
const nextBtn = document.createElement('button');
nextBtn.id = 'nextMonth';
nextBtn.textContent = '›';
navContainer.append(prevBtn, nextBtn);

header.append(monthSelect, navContainer);

const daysContainer = document.createElement('div');
daysContainer.className = 'calendar-grid';
daysContainer.id = 'calendarDays';

calendarPopup.append(header, daysContainer);
container.appendChild(calendarPopup);

const monthNames = [
  "Январь","Февраль","Март","Апрель","Май","Июнь",
  "Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"
];

let selectedDate = new Date();
let currentDate = new Date();

function renderMonthDropdown(year) {
  monthDropdown.innerHTML = "";
  monthNames.forEach((name, index) => {
    const opt = document.createElement("div");
    opt.className = "month-option";
    opt.textContent = name;
    opt.addEventListener("click", e => {
      e.stopPropagation();
      currentDate.setMonth(index);
      renderCalendar();
      monthDropdown.classList.remove("active");
    });
    monthDropdown.appendChild(opt);
  });
}

function createDayCell(day, monthOffset = 0) {
  const div = document.createElement("div");
  div.className = "calendar-day" + (monthOffset !== 0 ? " inactive" : "");
  div.textContent = day;

  div.addEventListener("click", () => {
    currentDate.setMonth(currentDate.getMonth() + monthOffset);
    selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
    console.log(`Выбрана дата: ${selectedDate.getDate()}.${selectedDate.getMonth()+1}.${selectedDate.getFullYear()}`);
    renderCalendar();
    calendarPopup.classList.remove("active");
  });

  if (monthOffset === 0 &&
      selectedDate.getDate() === day &&
      selectedDate.getMonth() === currentDate.getMonth() &&
      selectedDate.getFullYear() === currentDate.getFullYear()) {
    div.classList.add("selected");
  }

  return div;
}

function renderCalendar() {
  daysContainer.innerHTML = "";
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const firstWeekday = (firstDay.getDay() + 6) % 7; 
  const daysInMonth = lastDay.getDate();

  monthYear.textContent = `${monthNames[month]} ${year}`;
  renderMonthDropdown(year);

  const prevMonthDays = new Date(year, month, 0).getDate();
  const totalCells = firstWeekday + daysInMonth;
  const nextMonthFill = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);

  ["Пн","Вт","Ср","Чт","Пт","Сб","Вс"].forEach(name => {
    const div = document.createElement("div");
    div.className = "calendar-day-name";
    div.textContent = name;
    daysContainer.appendChild(div);
  });

  for(let i=firstWeekday-1; i>=0; i--) daysContainer.appendChild(createDayCell(prevMonthDays-i, -1));
  for(let d=1; d<=daysInMonth; d++) daysContainer.appendChild(createDayCell(d));
  for(let i=1; i<=nextMonthFill; i++) daysContainer.appendChild(createDayCell(i, 1));
}

[prevBtn, nextBtn].forEach((btn, idx) => {
  btn.addEventListener("click", e => {
    e.stopPropagation();
    currentDate.setMonth(currentDate.getMonth() + (idx === 0 ? -1 : 1));
    renderCalendar();
  });
});

calendarBtn.addEventListener("click", e => {
  e.stopPropagation();
  calendarPopup.classList.toggle("active");
  renderCalendar();
});

monthSelect.addEventListener("click", e => {
  e.stopPropagation();
  monthDropdown.classList.toggle("active");
});

document.addEventListener("click", () => {
  calendarPopup.classList.remove("active");
  monthDropdown.classList.remove("active");
});

renderCalendar();
</script>
</body>
</html>

appendTerms(aTerms, aTermCreator, aFilterValue) {
    if (!(aFilterValue.date instanceof Date)) {
      console.warn("QuickFilterManager: invalid date value", aFilterValue);
      return;
    }

    const startDate = new Date(aFilterValue.date.getFullYear(),
                               aFilterValue.date.getMonth(),
                               aFilterValue.date.getDate(), 0, 0, 0);
    const endDate = new Date(aFilterValue.date.getFullYear(),
                             aFilterValue.date.getMonth(),
                             aFilterValue.date.getDate() + 1, 0, 0, 0);

    // Конвертируем в PRTime (микросекунды)
    const startPRTime = startDate.getTime() * 1000;
    const endPRTime = endDate.getTime() * 1000;

    // term: Date >= startDate
    const termStart = aTermCreator.createTerm();
    termStart.attrib = Ci.nsMsgSearchAttrib.Date;
    termStart.op = Ci.nsMsgSearchOp.IsAfterOrEqual;
    termStart.value = Cc["@mozilla.org/messenger/search-value;1"]
                        .createInstance(Ci.nsIMsgSearchValue);
    termStart.value.attrib = termStart.attrib;
    termStart.value.date = startPRTime;
    termStart.booleanAnd = true;
    termStart.beginsGrouping = true;
    aTerms.push(termStart);

    // term: Date < endDate
    const termEnd = aTermCreator.createTerm();
    termEnd.attrib = Ci.nsMsgSearchAttrib.Date;
    termEnd.op = Ci.nsMsgSearchOp.IsBefore;
    termEnd.value = Cc["@mozilla.org/messenger/search-value;1"]
                      .createInstance(Ci.nsIMsgSearchValue);
    termEnd.value.attrib = termEnd.attrib;
    termEnd.value.date = endPRTime;
    termEnd.booleanAnd = true;
    termEnd.endsGrouping = true;
    aTerms.push(termEnd);
  },



